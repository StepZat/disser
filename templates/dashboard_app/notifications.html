{% extends 'base.html' %}
{% load static i18n %}

{% block extra_css %}
<link href="{% static 'css/notifications.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid p-4">

  {% include 'dashboard_app/_system_nav.html' with active='notifications' %}
  <h4 class="mb-4">{% trans "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" %}</h4>

  <div class="row g-4">
    <!-- Email-—Ñ–æ—Ä–º–∞ -->
    <div class="col-md-6">
      <form method="post" action="{% url 'system-notifications' %}">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="email">
        <div class="widget-card">
          <div class="widget-header">
            <span><i class="bi bi-envelope-fill me-2"></i> {% trans "Email" %}</span>
            <div class="form-check form-switch m-0">
              <input class="form-check-input"
                     type="checkbox"
                     id="email_enabled"
                     name="email_enabled"
                     {% if email_enabled == 'true' %}checked{% endif %}>
            </div>
          </div>
          <div class="widget-body">
            <!-- –≤—Å–µ –ø–æ–ª—è smtp_* -->
            <div class="mb-3">
              <label for="smtp-server" class="form-label">{% trans "–ê–¥—Ä–µ—Å –ø–æ—á—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞" %}</label>
              <input type="text" class="form-control" id="smtp-server" name="smtp_server" value="{{ smtp_server }}" required>
            </div>
            <div class="mb-3">
              <label for="smtp-port" class="form-label">{% trans "–ü–æ—Ä—Ç" %}</label>
              <input type="number" class="form-control" id="smtp-port" name="smtp_port" value="{{ smtp_port }}" required>
            </div>
            <div class="mb-3">
              <label for="smtp-user" class="form-label">{% trans "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" %}</label>
              <input type="text" class="form-control" id="smtp-user" name="smtp_user" value="{{ smtp_user }}" required>
            </div>
            <div class="mb-3">
              <label for="smtp-password" class="form-label">{% trans "–ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" %}</label>
              <input type="password" class="form-control" id="smtp-password" name="smtp_password" value="{{ smtp_password }}" required>
            </div>
            <div class="mb-3">
              <label for="smtp-timeout" class="form-label">{% trans "–¢–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (—Å–µ–∫)" %}</label>
              <input type="number" class="form-control" id="smtp-timeout" name="smtp_timeout" value="{{ smtp_timeout }}" required>
            </div>
            <!-- –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–ª—è smtp_port, smtp_user, smtp_password, smtp_timeout -->
            <div class="mb-3">
              <label for="smtp-security" class="form-label">{% trans "–ó–∞—â–∏—Ç–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è" %}</label>
              <select class="form-select" id="smtp-security" name="smtp_security" required>
                <option value="none"{% if smtp_security == 'none' %} selected{% endif %}>{% trans "–ù–µ—Ç" %}</option>
                <option value="ssl"{% if smtp_security == 'ssl' %} selected{% endif %}>{% trans "SSL/TLS" %}</option>
                <option value="starttls"{% if smtp_security == 'starttls' %} selected{% endif %}>{% trans "STARTTLS" %}</option>
              </select>
            </div>
            <!-- —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π -->
            <div class="mb-3">
              <label class="form-label">{% trans "–ü–æ–ª—É—á–∞—Ç–µ–ª–∏" %}</label>
              <div id="recipients-container">
                {% if email_recipients %}
                  {% for addr in email_recipients %}
                    <div class="input-group mb-2">
                      <input type="email"
                             name="email_recipients[]"
                             class="form-control"
                             placeholder="{% trans 'Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è' %}"
                             value="{{ addr }}">
                      {% if not forloop.first %}
                        <button type="button"
                                class="btn btn-outline-danger btn-sm remove-recipient"
                                aria-label="{% trans '–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è' %}">‚Äì</button>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="input-group mb-2">
                    <input type="email"
                           name="email_recipients[]"
                           class="form-control"
                           placeholder="{% trans 'Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è' %}">
                  </div>
                {% endif %}
              </div>
              <button type="button"
                      id="add-recipient"
                      class="btn btn-sm btn-outline-primary">
                + {% trans "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è" %}
              </button>
            </div>
            <!-- /—Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π -->
          </div>
          <div class="widget-footer d-flex justify-content-between">
            <div>
              <button type="button" class="btn btn-outline-secondary" id="email-test">
                {% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" %}
              </button>
            </div>
            <div>
              <button type="submit"
                      name="reset_email"
                      class="btn btn-reset">
                {% trans "–°–±—Ä–æ—Å–∏—Ç—å" %}</button>
              <button type="submit" name="save_email" class="btn btn-primary">{% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å Email" %}</button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Telegram-—Ñ–æ—Ä–º–∞ -->
    <div class="col-md-6">
      <form method="post" action="{% url 'system-notifications' %}">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="telegram">
        <div class="widget-card">
          <div class="widget-header">
            <span><i class="bi bi-telegram me-2"></i> {% trans "Telegram" %}</span>
            <div class="form-check form-switch m-0">
              <input class="form-check-input"
                     type="checkbox"
                     id="telegram_enabled"
                     name="telegram_enabled"
                     {% if telegram_enabled == 'true' %}checked{% endif %}>
            </div>
          </div>
          <div class="widget-body">
            <div class="mb-3">
              <label for="telegram-token" class="form-label">{% trans "API –¢–æ–∫–µ–Ω Telegram" %}</label>
              <input type="text" class="form-control" id="telegram-token" name="telegram_token" value="{{ telegram_token }}" required>
            </div>
            <div class="mb-3">
	          <label for="telegram-chat-id" class="form-label">{% trans "Chat ID –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π" %}</label>
	          <input type="text"
                     class="form-control"
                     id="telegram-chat-id"
                     name="telegram_chat_id"
                     value="{{ telegram_chat_id }}"
                     placeholder="{% trans '–í–∞—à Chat ID' %}"
                     required>
            </div>
          </div>
          <div class="widget-footer d-flex justify-content-between">
            <div>
              <button type="button" class="btn btn-outline-secondary" id="telegram-test">
                {% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" %}
              </button>
            </div>
            <div>
              <button type="submit"
                      name="reset_telegram"
                      class="btn btn-reset">
                {% trans "–°–±—Ä–æ—Å–∏—Ç—å" %}</button>
              <button type="submit" name="save_telegram" class="btn btn-primary">{% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å Telegram" %}</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal –¥–ª—è —Ç–µ—Å—Ç–∞ Email -->
<div class="modal fade" id="emailTestModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="email-test-form" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ Email" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans '–ó–∞–∫—Ä—ã—Ç—å' %}"></button>
      </div>
      <div class="modal-body">
        <label for="email-test-address" class="form-label">{% trans "Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è" %}</label>
        <input type="email" id="email-test-address" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "–û—Ç–º–µ–Ω–∏—Ç—å" %}</button>
        <button type="submit" class="btn btn-primary">{% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" %}</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal –¥–ª—è —Ç–µ—Å—Ç–∞ Telegram -->
<div class="modal fade" id="telegramTestModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="telegram-test-form" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{% trans "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ Telegram" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans '–ó–∞–∫—Ä—ã—Ç—å' %}"></button>
      </div>
      <div class="modal-body">
        <label for="telegram-test-chatid" class="form-label">{% trans "Chat ID" %}</label>
        <input type="text" id="telegram-test-chatid" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "–û—Ç–º–µ–Ω–∏—Ç—å" %}</button>
        <button type="submit" class="btn btn-primary">{% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" %}</button>
      </div>
    </form>
  </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Bootstrap-—Ç–æ—Å—Ç–∞ -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
  <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto" id="notificationToastHeader"></strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="{% trans '–ó–∞–∫—Ä—ã—Ç—å' %}"></button>
    </div>
    <div class="toast-body" id="notificationToastBody"></div>
  </div>
</div>
{% if messages %}
<script>
  window.djangoMessages = [
    {% for message in messages %}
      {
        level: '{{ message.tags }}',
        text: '{{ message|escapejs }}'
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
</script>
{% else %}
<script>window.djangoMessages = [];</script>
{% endif %}

<script>
(function() {
  // 1) CSRF –∏–∑ –∫—É–∫–∏
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  // 2) Toast setup
  const toastEl   = document.getElementById('notificationToast');
  const toast     = new bootstrap.Toast(toastEl, { delay: 5000, autohide: true });
  const hdr       = document.getElementById('notificationToastHeader');
  const body      = document.getElementById('notificationToastBody');

  // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–∫–∞–∑–∞
  let lastShow = 0;

  function showToast(msg, type) {
    // –ø–æ–º–µ—á–∞–µ–º –º–æ–º–µ–Ω—Ç –ø–æ–∫–∞–∑–∞
    lastShow = Date.now();

    // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ü–≤–µ—Ç –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
    toastEl.classList.remove('bg-success','bg-danger','text-white');
    if (type === 'success') {
      toastEl.classList.add('bg-success','text-white');
      hdr.textContent = "{% trans '–£—Å–ø–µ—Ö' %}";
    } else {
      toastEl.classList.add('bg-danger','text-white');
      hdr.textContent = "{% trans '–û—à–∏–±–∫–∞' %}";
    }
    body.textContent = msg;
    toast.show();
  }

  if (window.djangoMessages && Array.isArray(window.djangoMessages)) {
    window.djangoMessages.forEach(msg => {
      // —É—Ä–æ–≤–µ–Ω—å –º–æ–∂–µ—Ç –±—ã—Ç—å 'success', 'error', 'warning', 'info'
      const type = msg.level.includes('success') ? 'success'
                 : msg.level.includes('error')   ? 'error'
                 : 'info';
      showToast(msg.text, type);
    });
  }

  // 3) –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞ –≤–Ω–µ toasta
  document.addEventListener('click', e => {
    // –µ—Å–ª–∏ toasta —Å–µ–π—á–∞—Å –Ω–µ—Ç –∏–ª–∏ –æ–Ω –µ—â—ë –Ω–µ –ø–æ–∫–∞–∑–∞–Ω ‚Äî –≤—ã—Ö–æ–¥–∏–º
    if (!toastEl.classList.contains('show')) return;
    // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –∫–ª–∏–∫ (–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å—Ç–æ –≤—ã–∑–≤–∞–ª showToast)
    if (Date.now() - lastShow < 100) return;
    // –µ—Å–ª–∏ –∫–ª–∏–∫ –≤–Ω–µ toasta ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º
    if (!toastEl.contains(e.target)) {
      toast.hide();
    }
  });

  // 4) Email-—Ç–µ—Å—Ç
  const emailTestBtn   = document.getElementById('email-test');
  const emailTestModal = new bootstrap.Modal(document.getElementById('emailTestModal'));

  emailTestBtn.addEventListener('click', () => {
    if (!document.getElementById('email_enabled').checked) {
      return showToast("{% trans '–°–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è' %}", 'error');
    }
    emailTestModal.show();
  });

  document.getElementById('email-test-form').addEventListener('submit', async e => {
    e.preventDefault();
    const to = document.getElementById('email-test-address').value.trim();
    if (!to) {
      return showToast("{% trans '–£–∫–∞–∂–∏—Ç–µ email –ø–æ–ª—É—á–∞—Ç–µ–ª—è' %}", 'error');
    }
    emailTestModal.hide();
    try {
      const resp = await fetch("{% url 'system-notifications-test' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ channel: 'email', to })
      });
      if (resp.ok) {
        showToast("{% trans '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' %}", 'success');
      } else {
        throw new Error(resp.status);
      }
    } catch (err) {
      showToast("{% trans '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ö–æ–¥ –æ—à–∏–±–∫–∏:' %} " + err, 'error');
    }
  });

  // 5) Telegram-—Ç–µ—Å—Ç
  const telegramTestBtn   = document.getElementById('telegram-test');
  const telegramTestModal = new bootstrap.Modal(document.getElementById('telegramTestModal'));

  telegramTestBtn.addEventListener('click', () => {
    if (!document.getElementById('telegram_enabled').checked) {
      return showToast("{% trans '–°–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è' %}", 'error');
    }
    telegramTestModal.show();
  });

  document.getElementById('telegram-test-form').addEventListener('submit', async e => {
    e.preventDefault();
    const to = document.getElementById('telegram-test-chatid').value.trim();
    if (!to) {
      return showToast("{% trans '–£–∫–∞–∂–∏—Ç–µ Chat ID' %}", 'error');
    }
    telegramTestModal.hide();
    try {
      const resp = await fetch("{% url 'system-notifications-test' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ channel: 'telegram', to })
      });
      if (resp.ok) {
        showToast("{% trans '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' %}", 'success');
      } else {
        throw new Error(resp.status);
      }
    } catch (err) {
      showToast("{% trans '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ö–æ–¥ –æ—à–∏–±–∫–∏:' %} " + err, 'error');
    }
  });

})();
</script>

<script>
  console.log("üîî Recipients script loaded");

  const container = document.getElementById('recipients-container');
  const addBtn    = document.getElementById('add-recipient');

  if (!container) console.warn("recipients-container not found");
  if (!addBtn)    console.warn("add-recipient button not found");

  if (container && addBtn) {
    addBtn.addEventListener('click', () => {
      console.log("‚ûï add-recipient clicked");
      const div = document.createElement('div');
      div.className = 'input-group mb-2';
      div.innerHTML = `
        <input type="email" name="email_recipients[]" class="form-control"
               placeholder="{% trans 'Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è' %}">
        <button type="button" class="btn btn-outline-danger remove-recipient">‚Äì</button>
      `;
      container.append(div);
    });
    container.addEventListener('click', e => {
      if (e.target.classList.contains('remove-recipient')) {
        console.log("‚ûñ remove-recipient clicked");
        e.target.closest('.input-group').remove();
      }
    });
  }
</script>
{% endblock %}
