{% extends 'base.html' %}
{% load static i18n %}

{% block extra_css %}
<link href="{% static 'css/notifications.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  {% include 'dashboard_app/_system_nav.html' with active='notifications' %}
  <h4 class="mb-4">{% trans "Уведомления" %}</h4>

  <div class="row g-4">
    <!-- Email-форма -->
    <div class="col-md-6">
      <form method="post" action="{% url 'system-notifications' %}">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="email">
        <div class="widget-card">
          <div class="widget-header">
            <span><i class="bi bi-envelope-fill me-2"></i> {% trans "Email" %}</span>
            <div class="form-check form-switch m-0">
              <input class="form-check-input"
                     type="checkbox"
                     id="email_enabled"
                     name="email_enabled"
                     {% if email_enabled == 'true' %}checked{% endif %}>
            </div>
          </div>
          <div class="widget-body">
            <!-- все поля smtp_* -->
            <div class="mb-3">
              <label for="smtp-server" class="form-label">{% trans "Адрес почтового сервера" %}</label>
              <input type="text" class="form-control" id="smtp-server" name="smtp_server" value="{{ smtp_server }}" required>
            </div>
            <div class="mb-3">
              <label for="smtp-port" class="form-label">{% trans "Порт" %}</label>
              <input type="number" class="form-control" id="smtp-port" name="smtp_port" value="{{ smtp_port }}" required>
            </div>
            <div class="mb-3">
              <label for="smtp-user" class="form-label">{% trans "Имя пользователя" %}</label>
              <input type="text" class="form-control" id="smtp-user" name="smtp_user" value="{{ smtp_user }}" required>
            </div>
            <div class="mb-3">
              <label for="smtp-password" class="form-label">{% trans "Пароль пользователя" %}</label>
              <input type="password" class="form-control" id="smtp-password" name="smtp_password" value="{{ smtp_password }}" required>
            </div>
            <div class="mb-3">
              <label for="smtp-timeout" class="form-label">{% trans "Таймаут соединения (сек)" %}</label>
              <input type="number" class="form-control" id="smtp-timeout" name="smtp_timeout" value="{{ smtp_timeout }}" required>
            </div>
            <!-- повторить для smtp_port, smtp_user, smtp_password, smtp_timeout -->
            <div class="mb-3">
              <label for="smtp-security" class="form-label">{% trans "Защита соединения" %}</label>
              <select class="form-select" id="smtp-security" name="smtp_security" required>
                <option value="none"{% if smtp_security == 'none' %} selected{% endif %}>{% trans "Нет" %}</option>
                <option value="ssl"{% if smtp_security == 'ssl' %} selected{% endif %}>{% trans "SSL/TLS" %}</option>
                <option value="starttls"{% if smtp_security == 'starttls' %} selected{% endif %}>{% trans "STARTTLS" %}</option>
              </select>
            </div>
            <!-- список получателей -->
            <div class="mb-3">
              <label class="form-label">{% trans "Получатели" %}</label>
              <div id="recipients-container">
                {% if email_recipients %}
                  {% for addr in email_recipients %}
                    <div class="input-group mb-2">
                      <input type="email"
                             name="email_recipients[]"
                             class="form-control"
                             placeholder="{% trans 'Email получателя' %}"
                             value="{{ addr }}">
                      {% if not forloop.first %}
                        <button type="button"
                                class="btn btn-outline-danger btn-sm remove-recipient"
                                aria-label="{% trans 'Удалить получателя' %}">–</button>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="input-group mb-2">
                    <input type="email"
                           name="email_recipients[]"
                           class="form-control"
                           placeholder="{% trans 'Email получателя' %}">
                  </div>
                {% endif %}
              </div>
              <button type="button"
                      id="add-recipient"
                      class="btn btn-sm btn-outline-primary">
                + {% trans "Добавить получателя" %}
              </button>
            </div>
            <!-- /список получателей -->
          </div>
          <div class="widget-footer d-flex justify-content-between">
            <div>
              <button type="button" class="btn btn-outline-secondary" id="email-test">
                {% trans "Отправить тестовое сообщение" %}
              </button>
            </div>
            <div>
              <button type="submit"
                      name="reset_email"
                      class="btn btn-reset">
                {% trans "Сбросить" %}</button>
              <button type="submit" class="btn btn-primary">{% trans "Сохранить Email" %}</button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Telegram-форма -->
    <div class="col-md-6">
      <form method="post" action="{% url 'system-notifications' %}">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="telegram">
        <div class="widget-card">
          <div class="widget-header">
            <span><i class="bi bi-telegram me-2"></i> {% trans "Telegram" %}</span>
            <div class="form-check form-switch m-0">
              <input class="form-check-input"
                     type="checkbox"
                     id="telegram_enabled"
                     name="telegram_enabled"
                     {% if telegram_enabled == 'true' %}checked{% endif %}>
            </div>
          </div>
          <div class="widget-body">
            <div class="mb-3">
              <label for="telegram-token" class="form-label">{% trans "API Токен Telegram" %}</label>
              <input type="text" class="form-control" id="telegram-token" name="telegram_token" value="{{ telegram_token }}" required>
            </div>
            <div class="mb-3">
	          <label for="telegram-chat-id" class="form-label">{% trans "Chat ID для уведомлений" %}</label>
	          <input type="text"
                     class="form-control"
                     id="telegram-chat-id"
                     name="telegram_chat_id"
                     value="{{ telegram_chat_id }}"
                     placeholder="{% trans 'Ваш Chat ID' %}"
                     required>
            </div>
          </div>
          <div class="widget-footer d-flex justify-content-between">
            <div>
              <button type="button" class="btn btn-outline-secondary" id="telegram-test">
                {% trans "Отправить тестовое сообщение" %}
              </button>
            </div>
            <div>
              <button type="submit"
                      name="reset_telegram"
                      class="btn btn-reset">
                {% trans "Сбросить" %}</button>
              <button type="submit" class="btn btn-primary">{% trans "Сохранить Telegram" %}</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  // CSRF-токен из куки
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  // Обработчики тестовых кнопок
  document.getElementById('email-test').addEventListener('click', async () => {
    const to = prompt("{% trans 'Введите email для тестового сообщения' %}");
    if (!to) return;
    try {
      const resp = await fetch("{% url 'system-notifications-test' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ channel: 'email', to })
      });
      if (resp.ok) alert("{% trans 'Тестовое сообщение отправлено' %}");
      else throw new Error(resp.status);
    } catch (e) {
      alert("{% trans 'Не удалось отправить тестовое сообщение:' %} " + e);
    }
  });

  document.getElementById('telegram-test').addEventListener('click', async () => {
    let to = document.getElementById('telegram-chat-id').value.trim();
    if (!to) {
      to = prompt("{% trans 'Введите Chat ID для тестового сообщения' %}");
    }
    if (!to) return;
    try {
      const resp = await fetch("{% url 'system-notifications-test' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ channel: 'telegram', to })
      });
      if (resp.ok) alert("{% trans 'Тестовое сообщение отправлено' %}");
      else throw new Error(resp.status);
    } catch (e) {
      alert("{% trans 'Не удалось отправить тестовое сообщение:' %} " + e);
    }
  });
})();
</script>
<script>
  console.log("🔔 Recipients script loaded");

  const container = document.getElementById('recipients-container');
  const addBtn    = document.getElementById('add-recipient');

  if (!container) console.warn("recipients-container not found");
  if (!addBtn)    console.warn("add-recipient button not found");

  if (container && addBtn) {
    addBtn.addEventListener('click', () => {
      console.log("➕ add-recipient clicked");
      const div = document.createElement('div');
      div.className = 'input-group mb-2';
      div.innerHTML = `
        <input type="email" name="email_recipients[]" class="form-control"
               placeholder="{% trans 'Email получателя' %}">
        <button type="button" class="btn btn-outline-danger remove-recipient">–</button>
      `;
      container.append(div);
    });
    container.addEventListener('click', e => {
      if (e.target.classList.contains('remove-recipient')) {
        console.log("➖ remove-recipient clicked");
        e.target.closest('.input-group').remove();
      }
    });
  }
</script>
{% endblock %}
